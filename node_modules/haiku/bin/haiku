#!/usr/bin/env node

var cli = require('command-router')
  , fs = require('graceful-fs')
  , path = require('path')
  , haiku = require('../')

cli.option({ name: 'src'
, default: process.cwd()
, type: path
})

cli.option({ name: 'log-level'
, default: 'warn'
, type: String
})

// # CLI routes
cli.on('notfound', help)

cli.command('build', function(){
  haiku(cli.src)
  .configure(cli.options)
  .on('error', function(err){
    // TODO: spill a meaningful error message instead of throwing
    throw err
  })
  .on('end', function(){
    var h = this
      , rimraf = require('rimraf')
      , logger = h.logger

    logger.info('removing --build-dir %s', h.opt('build-dir'))

    rimraf(h.opt('build-dir'), function(err){
      if (err) return h.emit(err)

      h.pages.forEach(function(page){
        page.build(function(err, built){
          if (err) return h.emit('error', err)
          else return finish()
        })
      })

      var counter = 0

      function finish(){
        counter++

        if (counter === h.pages.length)
          logger.info('finished building')
      }
    })
  })
})

// Kick the whole thing off...
cli.parse(process.argv)

// # help(action)
//
// Display help for `action` defined in doc/cli/<action>.md then exit 1
//
//    help('build')
//
function help(action){
  var action = action || 'index'
    , file = path.join(__dirname, '..', 'doc', 'cli', action + '.md')

  // Add a newline
  console.log()

  // `cli.on('notfound', help)` makes its possible to try and look up
  // help for non-existent commands. If that is the case just show the
  // default.
  fs.exists(file, function(exists){
    if (!exists) return help()

    fs.createReadStream(file, { encoding: 'utf8' })
    .on('data', console.log)
    .on('error', function(err){ throw err })
    .on('end', function(){ process.exit(1) })
  })
}
